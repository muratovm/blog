{{ define "main" }}
{{ $blogPosts := where site.RegularPages "Section" "blog" }}
{{ $blogPosts = where $blogPosts "Draft" false }}
{{ $storyPosts := slice }}
{{ $artifactPosts := slice }}
{{ range $blogPosts }}
{{ $path := lower .File.Path }}
{{ $kind := lower (default "" .Params.kind) }}
{{ if or (eq $kind "story") (in $path "blog/stories/") }}
{{ $storyPosts = $storyPosts | append . }}
{{ else if or (eq $kind "artifact") (in $path "blog/artifacts/") }}
{{ $artifactPosts = $artifactPosts | append . }}
{{ else }}
{{ $artifactPosts = $artifactPosts | append . }}
{{ end }}
{{ end }}
{{ $storyPosts = sort $storyPosts "Date" "desc" }}
{{ $artifactPosts = sort $artifactPosts "Date" "desc" }}
{{ $allPosts := $storyPosts | append $artifactPosts }}
{{ $allPosts = sort $allPosts "Date" "desc" }}
{{ $posts := $storyPosts }}
{{ if eq (len $posts) 0 }}
{{ $posts = $artifactPosts }}
{{ end }}
{{ $postsByDate := $posts }}
{{ $featured := first 1 $postsByDate }}
{{ $updatedPosts := slice }}
{{ range $allPosts }}
{{ if gt .Lastmod .Date }}
{{ $updatedPosts = $updatedPosts | append . }}
{{ end }}
{{ end }}
{{ $updatedPosts = sort $updatedPosts "Lastmod" "desc" }}

{{ $startSlugs := .Params.start_here }}
{{ if not $startSlugs }}
{{ $startSlugs = slice "how-this-blog-works" "binary-search-python" "toy-car-ml" }}
{{ end }}
{{ $startPages := slice }}
{{ range $startSlugs }}
{{ $matches := where $allPosts "Params.slug" . }}
{{ if gt (len $matches) 0 }}
{{ $startPages = $startPages | append (index $matches 0) }}
{{ end }}
{{ end }}

{{ $stories := $storyPosts }}
{{ $artifacts := $artifactPosts }}

<main class="home-layout">
  {{ partial "status_blurb.html" . }}
  {{ partial "momentum_blurb.html" . }}

  <section class="home-featured">
    <div class="home-section-head">
      <h3>Latest Feature</h3>
      <a href="{{ "blog/" | relURL }}">Browse all posts</a>
    </div>
    {{ range $featured }}
    {{ $page := . }}
    <article class="home-featured-card">
      {{ $featureImg := .Resources.GetMatch .Params.image }}
      {{ if not $featureImg }}
      {{ $featureImg = resources.Get (printf "banners/%s" .Params.image) }}
      {{ end }}
      {{ if and $featureImg (eq $featureImg.ResourceType "image") }}
      {{ $featureImg = $featureImg.Fill "1200x675 smart webp q82" }}
      {{ end }}
      {{ with $featureImg }}
      <a href="{{ $page.RelPermalink }}">
        <img src="{{ .RelPermalink }}" width="{{ .Width }}" height="{{ .Height }}" loading="lazy"
          alt="{{ $page.Title }}">
      </a>
      {{ end }}
      <div class="home-featured-body">
        <p class="home-meta">{{ .Date.Format "Jan 2, 2006" }} · {{ .ReadingTime }} min read</p>
        <h4><a href="{{ .RelPermalink }}">{{ .Title }}</a></h4>
        <p>{{ .Description }}</p>
      </div>
    </article>
    {{ end }}
  </section>

  <section class="home-start-here">
    <div class="home-section-head">
      <h3>⌖ Pinned</h3>
    </div>
    <div class="home-grid home-grid-3">
      {{ range $startPages }}
      {{ $page := . }}
      <article class="home-card">
        {{ $cardImg := .Resources.GetMatch .Params.image }}
        {{ if not $cardImg }}
        {{ $cardImg = resources.Get (printf "banners/%s" .Params.image) }}
        {{ end }}
        {{ if and $cardImg (eq $cardImg.ResourceType "image") }}
        {{ $cardImg = $cardImg.Fill "720x405 smart webp q80" }}
        {{ end }}
        {{ with $cardImg }}
        <a href="{{ $page.RelPermalink }}">
          <img src="{{ .RelPermalink }}" width="{{ .Width }}" height="{{ .Height }}" loading="lazy"
            alt="{{ $page.Title }}">
        </a>
        {{ end }}
        <h4><a href="{{ .RelPermalink }}">{{ .Title }}</a></h4>
        <p>{{ .Description }}</p>
      </article>
      {{ end }}
    </div>
  </section>

  <section class="home-tracks">
    <div class="home-section-head">
      <h3>Explore by Type</h3>
    </div>
    <div class="home-grid home-grid-1">
      <article class="home-track">
        <div class="home-track-head">
          <h4>Stories</h4>
          <a href="{{ "blog/stories/" | relURL }}">View all</a>
        </div>
        <ul>
          {{ range first 3 $stories }}
          <li><a href="{{ .RelPermalink }}">{{ .Title }}</a><span>{{ .Date.Format "Jan 2" }}</span></li>
          {{ else }}
          <li><span>No stories yet</span><span>—</span></li>
          {{ end }}
        </ul>
      </article>

      <article class="home-track">
        <div class="home-track-head">
          <h4>Artifacts</h4>
          <a href="{{ "blog/artifacts/" | relURL }}">View all</a>
        </div>
        <ul>
          {{ range first 3 $artifacts }}
          <li><a href="{{ .RelPermalink }}">{{ .Title }}</a><span>{{ .Date.Format "Jan 2" }}</span></li>
          {{ else }}
          <li><span>No artifacts yet</span><span>—</span></li>
          {{ end }}
        </ul>
      </article>
    </div>
  </section>

  <section class="home-recent">
    <div class="home-section-head">
      <h3>Recent Activity</h3>
    </div>
    <ul class="home-recent-list">
      {{ range first 6 $allPosts }}
      <li>
        <span>{{ .Date.Format "Jan 2, 2006" }}</span>
        <a href="{{ .RelPermalink }}">{{ .Title }}</a>
        <em>{{ .ReadingTime }} min read</em>
      </li>
      {{ end }}
    </ul>
  </section>

  {{ if gt (len $updatedPosts) 0 }}
  <section class="home-updated">
    <div class="home-section-head">
      <h3>Recently Updated</h3>
    </div>
    <ul class="home-updated-list">
      {{ range first 4 $updatedPosts }}
      <li>
        <span>{{ .Lastmod.Format "Jan 2, 2006" }}</span>
        <a href="{{ .RelPermalink }}">{{ .Title }}</a>
        <em>Originally {{ .Date.Format "Jan 2, 2006" }}</em>
      </li>
      {{ end }}
    </ul>
  </section>
  {{ end }}

  <section class="home-archive-cta">
    <div class="home-section-head">
      <h3>Archive</h3>
      <a href="{{ "archive/" | relURL }}">Open archive</a>
    </div>
    <p>Browse all posts in a chronological index by year and month.</p>
  </section>
</main>
{{ end }}
