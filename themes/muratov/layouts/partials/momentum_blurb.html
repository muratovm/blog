{{ $posts := where site.RegularPages "Section" "blog" }}
{{ $posts = where $posts "Draft" false }}
{{ if gt (len $posts) 0 }}
  {{ $weekStart := now.AddDate 0 0 -7 }}
  {{ $publishedWeek := where $posts "Date" "ge" $weekStart }}
  {{ $editedWeek := where $posts "Lastmod" "ge" $weekStart }}
  {{ $latest := index (sort $posts "Lastmod" "desc") 0 }}
  {{ $daysSince := div (sub (int now.Unix) (int $latest.Lastmod.Unix)) 86400 }}
  {{ $weeks := int 8 }}
  {{ $chartW := int 220 }}
  {{ $chartH := int 54 }}
  {{ $weekday := int now.Weekday }}
  {{ $startOfWeek := now.AddDate 0 0 (mul -1 (sub $weekday 1)) }}
  {{ if eq $weekday 0 }}
    {{ $startOfWeek = now.AddDate 0 0 -6 }}
  {{ end }}
  {{ $startOfWeek = time.AsTime ($startOfWeek.Format "2006-01-02") }}
  {{ $startUnix := int (($startOfWeek.AddDate 0 0 (mul -7 (sub $weeks 1))).Unix) }}
  {{ $counts := slice }}
  {{ $maxCount := int 1 }}
  {{ range seq 0 (sub $weeks 1) }}
    {{ $i := . }}
    {{ $bucketStart := add $startUnix (mul $i 604800) }}
    {{ $bucketEnd := add $bucketStart 604800 }}
    {{ $count := int 0 }}
    {{ range $posts }}
      {{ $lastmodUnix := int .Lastmod.Unix }}
      {{ if and (ge $lastmodUnix $bucketStart) (lt $lastmodUnix $bucketEnd) }}
        {{ $count = add $count 1 }}
      {{ end }}
    {{ end }}
    {{ $counts = $counts | append $count }}
    {{ if gt $count $maxCount }}
      {{ $maxCount = $count }}
    {{ end }}
  {{ end }}
  {{ $stepX := div (sub $chartW 1) (sub $weeks 1) }}
  {{ $points := slice }}
  {{ $areaPoints := slice (printf "0,%d" (sub $chartH 5)) }}
  {{ $lastPoint := "" }}
  {{ range $i, $count := $counts }}
    {{ $x := mul $i $stepX }}
    {{ $scaled := div (mul $count (sub $chartH 10)) $maxCount }}
    {{ $y := sub (sub $chartH 5) $scaled }}
    {{ $pt := printf "%d,%d" $x $y }}
    {{ $points = $points | append $pt }}
    {{ $areaPoints = $areaPoints | append $pt }}
    {{ $lastPoint = $pt }}
  {{ end }}
  {{ $areaPoints = $areaPoints | append (printf "%d,%d" (sub $chartW 1) (sub $chartH 5)) }}
  {{ $lastParts := split $lastPoint "," }}
  {{ $lastX := index $lastParts 0 }}
  {{ $lastY := index $lastParts 1 }}
  <section class="home-momentum">
    <p class="home-momentum-label">Momentum</p>
    <div class="home-momentum-content">
      <div class="home-momentum-grid">
        <span><strong>{{ $daysSince }}</strong> days since last update</span>
        <span><strong>{{ len $editedWeek }}</strong> touched (7d)</span>
        <span><strong>{{ len $publishedWeek }}</strong> published (7d)</span>
      </div>
      <div class="home-momentum-trend">
        <p class="home-momentum-trend-label">8-week trend</p>
        <svg class="home-momentum-sparkline" viewBox="0 0 {{ $chartW }} {{ $chartH }}" preserveAspectRatio="xMinYMid meet" role="img" aria-label="8 week momentum trend">
          <line class="home-momentum-sparkline-baseline" x1="0" y1="{{ sub $chartH 5 }}" x2="{{ sub $chartW 1 }}" y2="{{ sub $chartH 5 }}" />
          <polygon class="home-momentum-sparkline-area" points="{{ delimit $areaPoints " " }}" />
          <polyline class="home-momentum-sparkline-line" points="{{ delimit $points " " }}" />
          <circle class="home-momentum-sparkline-dot" cx="{{ $lastX }}" cy="{{ $lastY }}" r="2.6" />
        </svg>
      </div>
    </div>
  </section>
{{ end }}
